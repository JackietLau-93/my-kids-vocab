<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>TinyVocab Levels</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Jua&family=Noto+Sans+SC:wght@500;700&family=Noto+Sans+TC:wght@500;700&family=Zen+Maru+Gothic:wght@500;700&display=swap" rel="stylesheet">

<style>
    :root {
        /* Semantic Colors */
        --c-animal: #7CB342; --c-food: #FDD835; --c-body: #42A5F5; 
        --c-home: #EF5350; --c-act: #AB47BC;
        
        /* Rainbow Grammar */
        --pos-noun: #2196F3; --pos-verb: #F44336; --pos-adj: #4CAF50;
        --pos-adv: #F9A825; --pos-pron: #9C27B0; --pos-prep: #E91E63; --pos-conj: #FF9800;
        
        --g-masc: #2196F3; --g-fem: #E91E63; --g-neut: #4CAF50;
        --bg: #F2F2F2; --card-bg: #FFFFFF;
        
        /* Level Slider Colors */
        --lvl-1: #4CAF50; --lvl-2: #FF9800; --lvl-3: #F44336;
    }

    body { font-family: 'Zen Maru Gothic', sans-serif; background: var(--bg); margin: 0; color: #333; -webkit-font-smoothing: antialiased; }

    /* FONTS */
    .font-en, .font-fr, .font-de, .font-it, .font-ru { font-family: 'Fredoka One', cursive; }
    .font-ja { font-family: 'Zen Maru Gothic', sans-serif; font-weight: 700; }
    .font-ko { font-family: 'Jua', sans-serif; }
    .font-zh-cn { font-family: 'Noto Sans SC', sans-serif; font-weight: 700; letter-spacing: 1px; }
    .font-zh-tw { font-family: 'Noto Sans TC', sans-serif; font-weight: 700; letter-spacing: 1px; }

    /* HEADER & LEVEL SLIDER */
    header { 
        background: rgba(255,255,255,0.98); padding: 15px 20px; 
        position: sticky; top: 0; z-index: 100;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        display: flex; flex-direction: column; gap: 10px;
    }
    .top-row { display: flex; justify-content: space-between; align-items: center; width: 100%; flex-wrap: wrap; gap: 10px;}
    
    #lang-select { padding: 8px 12px; border: 1px solid #ddd; border-radius: 20px; font-family: 'Zen Maru Gothic'; font-weight: bold; outline: none; }
    .btn { padding: 8px 16px; border: 1px solid #ddd; border-radius: 20px; cursor: pointer; background: white; font-family: 'Fredoka One'; color: #555; font-size: 0.85rem;}
    .btn-primary { background: #333; color: white; border-color: #333; }

    /* LEVEL SLIDER CONTAINER */
    .level-container { display: flex; align-items: center; gap: 15px; width: 100%; padding: 5px 0; border-top: 1px solid #eee; }
    .level-label { font-family: 'Fredoka One'; font-size: 0.9rem; color: #555; width: 60px; }
    input[type=range] {
        flex: 1; -webkit-appearance: none; width: 100%; height: 6px; background: #ddd; border-radius: 5px; outline: none;
    }
    input[type=range]::-webkit-slider-thumb {
        -webkit-appearance: none; appearance: none; width: 24px; height: 24px; border-radius: 50%; 
        background: var(--lvl-1); cursor: pointer; transition: background 0.3s;
    }
    /* Dynamic Slider Color Classes (applied via JS) */
    .lvl-1::-webkit-slider-thumb { background: var(--lvl-1) !important; }
    .lvl-2::-webkit-slider-thumb { background: var(--lvl-2) !important; }
    .lvl-3::-webkit-slider-thumb { background: var(--lvl-3) !important; }

    .controls-row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; min-height: 35px; }

    /* TOGGLES */
    .toggle-group { display: flex; align-items: center; gap: 6px; font-size: 0.8rem; font-weight: bold; color: #555; cursor: pointer; background: #fff; padding: 4px 8px; border-radius: 15px; border: 1px solid #eee; transition: all 0.3s; }
    .switch { position: relative; display: inline-block; width: 32px; height: 18px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: #333; }
    input:checked + .slider:before { transform: translateX(14px); }
    .toggle-group.disabled { opacity: 0.4; pointer-events: none; filter: grayscale(1); }
    /* Hidden logic for Level system */
    .toggle-group.lvl-hidden { display: none; }

    /* CARD GRID */
    .container { max-width: 1200px; margin: 0 auto; padding: 30px 20px; }
    .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(170px, 1fr)); gap: 25px; }
    
    .vocab-card { aspect-ratio: 3/4; background-color: transparent; perspective: 1000px; cursor: pointer; }
    .card-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.6s; transform-style: preserve-3d; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.06); }
    .vocab-card.flipped .card-inner { transform: rotateY(180deg); }
    .card-front, .card-back { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; border-radius: 16px; overflow: hidden; background: var(--card-bg); display: flex; flex-direction: column; }
    .card-back { transform: rotateY(180deg); background: #fdfdfd; padding: 15px; box-sizing: border-box; align-items: center; justify-content: flex-start; }

    .card-art { flex: 1; width: 100%; display: flex; align-items: center; justify-content: center; padding: 15px; box-sizing: border-box; }
    .card-art img { max-width: 100%; max-height: 100%; object-fit: contain; filter: brightness(1.03) contrast(1.03); mix-blend-mode: multiply; }
    .card-obi { min-height: 80px; display: flex; flex-direction: column; align-items: center; justify-content: center; padding-bottom: 5px; position: relative; }
    .color-stroke { position: absolute; bottom: 0; left: 0; width: 100%; height: 6px; }
    
    .word-row { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px; margin-bottom: 2px; }
    .word { font-size: 1.8rem; color: #333; text-align: center; line-height: 1.2; }
    .sub-word { font-size: 0.9rem; color: #777; font-family: 'Zen Maru Gothic'; text-align: center; font-weight: 500; }
    .gender-badge { font-size: 0.75rem; color: #999; font-style: italic; margin-top: 2px; font-family: 'Zen Maru Gothic'; }

    .pos-badge { font-size: 0.6rem; color: white; padding: 3px 8px; border-radius: 10px; font-family: 'Zen Maru Gothic'; font-weight: bold; letter-spacing: 0.5px; text-transform: lowercase; margin-top: 4px; display: none; }
    .pos-noun { background: var(--pos-noun); } .pos-verb { background: var(--pos-verb); } .pos-adj { background: var(--pos-adj); }
    .show-grammar .pos-badge { display: inline-block; }

    .flip-btn { position: absolute; top: 10px; right: 10px; width: 32px; height: 32px; border-radius: 50%; background: rgba(255,255,255,0.9); border: 1px solid #eee; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; cursor: pointer; z-index: 10; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

    /* BACK TABLE */
    .back-title { font-family: 'Fredoka One'; font-size: 1.1rem; color: #333; margin-bottom: 15px; margin-top: 10px; }
    .comp-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; text-align: left; }
    .comp-table tr { border-bottom: 1px solid #eee; }
    .comp-table td { padding: 8px 4px; }
    .g-masc { color: var(--g-masc); } .g-fem { color: var(--g-fem); } .g-neut { color: var(--g-neut); }
    .close-flip { margin-top: auto; padding: 8px 20px; border-radius: 20px; background: #eee; border: none; font-family: 'Fredoka One'; color: #555; cursor: pointer; }

    /* CHILD MODE */
    #child-mode { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #fff; z-index: 200; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    .child-toggles { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; margin-bottom: 20px; }
    .focus-card { width: 85vw; max-width: 400px; aspect-ratio: 3/4; background: white; border-radius: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.1); display: flex; flex-direction: column; overflow: hidden; }
    .focus-card img { flex: 1; object-fit: contain; padding: 40px; filter: brightness(1.03) contrast(1.03); mix-blend-mode: multiply; }
    .focus-card .word-box { height: 160px; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 10px; box-sizing: border-box;}
    .focus-card h1 { font-size: 3.5rem; margin: 0; color: #333; line-height: 1; }
    .controls { margin-top: 30px; display: flex; gap: 20px; }
    .nav-btn { width: 70px; height: 70px; border-radius: 50%; border: none; font-size: 2rem; background: #f5f5f5; cursor: pointer; color: #333; }
    .play-btn { width: 90px; height: 90px; font-size: 3rem; background: #333; color: white; }

    /* PRINT */
    #print-area { display: none; }
    @media print {
        header, .container, #child-mode { display: none !important; }
        #print-area { display: block !important; width: 100%; height: 100%; }
        .cut-guide { border: 1px dashed #e0e0e0; box-sizing: border-box; background: white; position: relative; display: flex; flex-direction: column; border-radius: 6px; }
        .grid-poker { display: grid; grid-template-columns: repeat(3, 63.5mm); grid-template-rows: repeat(3, 88.9mm); padding: 10mm; gap: 2mm; }
        .grid-poker img { flex: 1; width: 100%; object-fit: contain; padding: 10px; }
        .grid-poker .txt { height: 25mm; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 18pt; color: #333; margin-bottom: 2mm; text-align: center;}
        .grid-poker .bar { height: 3mm; width: 100%; position: absolute; bottom: 0; left: 0; }
        .layout-a4 .page { break-after: page; width: 100vw; height: 100vh; display: flex; align-items: center; justify-content: center; }
        .layout-a4 .txt { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 80pt; color: #333; text-align: center; }
        .layout-a4 .bar { width: 15px; height: 100%; position: static; }
    }
</style>
</head>
<body>

<header>
    <div class="top-row">
        <div style="font-weight:bold; font-size:1.2rem; color:#333; font-family:'Fredoka One'">ü¶Å TinyVocab</div>
        <select id="lang-select">
            <option value="en">üá¨üáß English</option>
            <option value="fr">üá´üá∑ French</option>
            <option value="de">üá©üá™ German</option>
            <option value="it">üáÆüáπ Italian</option>
            <option value="ru">üá∑üá∫ Russian</option>
            <option value="zh">üá®üá≥ Chinese</option>
            <option value="ja">üáØüáµ Japanese</option>
            <option value="ko">üá∞üá∑ Korean</option>
        </select>
        <div style="display:flex; gap:8px;">
            <button class="btn" onclick="printA4()">Poster</button>
            <button class="btn" onclick="printPoker()">Cards</button>
            <button class="btn btn-primary" onclick="startChild()">‚ñ∂ Child Mode</button>
        </div>
    </div>
    
    <div class="level-container">
        <div class="level-label" id="lvl-txt">Level 1</div>
        <input type="range" min="1" max="3" value="1" class="lvl-1" id="level-slider" oninput="updateLevel(this.value)">
    </div>

    <div class="controls-row" id="header-toggles"></div>
</header>

<div class="container">
    <div class="card-grid" id="grid"></div>
</div>

<div id="child-mode" style="display:none;">
    <button onclick="exitChild()" style="position:absolute; top:30px; right:30px; border:none; background:none; font-size:2rem; opacity:0.3; cursor:pointer;">‚úï</button>
    <div id="child-toggles" class="child-toggles"></div>
    <div class="focus-card" id="focus-display">
        <img id="c-img" src="">
        <div class="word-box">
            <h1 id="c-word">Word</h1>
            <h2 id="c-sub"></h2>
            <div id="c-pos" class="pos-badge"></div>
            <div id="c-gender" class="gender-badge" style="font-size: 1.2rem;"></div>
        </div>
        <div class="focus-stripe" id="c-stripe"></div>
    </div>
    <div class="controls">
        <button class="nav-btn" onclick="move(-1)">üëà</button>
        <button class="nav-btn play-btn" onclick="speakDrill()">üîä</button>
        <button class="nav-btn" onclick="move(1)">üëâ</button>
    </div>
</div>

<div id="print-area"></div>

<script>
    let deck = [];
    let currentIndex = 0;
    let currentLang = 'en';
    let currentLevel = 1;

    // --- CONFIGS ---
    // Defined by LANGUAGE
    const langConfig = {
        'en': { toggles: ['grammar', 'article', 'plural', 'ipa', 'conjugate'] },
        'fr': { toggles: ['grammar', 'article', 'plural', 'gender', 'ipa', 'fem', 'conjugate'] },
        'de': { toggles: ['grammar', 'article', 'plural', 'gender', 'ipa', 'fem', 'neut', 'conjugate'] },
        'it': { toggles: ['grammar', 'article', 'plural', 'gender', 'ipa', 'fem', 'conjugate'] },
        'ru': { toggles: ['grammar', 'plural', 'gender', 'latin', 'ipa', 'fem', 'neut', 'conjugate'] },
        'zh': { toggles: ['grammar', 'traditional', 'pinyin'] },
        'ja': { toggles: ['grammar', 'hiragana'] },
        'ko': { toggles: ['grammar', 'hanja'] }
    };

    // Defined by LEVEL (Minimum Level required to show)
    const levelConfig = {
        'ipa': 1, 'pinyin': 1, 'latin': 1, 'hiragana': 1, 'hanja': 1, 'traditional': 1, 'gender': 1, 'article': 1,
        'grammar': 2, 'plural': 2,
        'fem': 3, 'neut': 3, 'conjugate': 3
    };

    const toggleLabels = { 
        'grammar': 'Grammar', 'plural':'Plural', 'article':'Article', 'gender':'Gender', 
        'pinyin':'Pinyin', 'latin':'Latin', 'ipa':'IPA',
        'hiragana':'Hiragana', 'hanja':'Hanja', 'traditional':'Traditional',
        'fem': 'Feminine', 'neut': 'Neuter', 'conjugate': 'Action'
    };

    let toggleState = { 
        grammar: false, plural:false, article:false, gender:false, 
        pinyin:false, latin:false, ipa:false, hiragana:false, hanja:false, traditional:false,
        fem: false, neut: false, conjugate: false
    };

    const colors = { animal: '#7CB342', food: '#FDD835', body: '#42A5F5', home: '#EF5350', act: '#AB47BC' };

    fetch('data.json').then(res => res.json()).then(data => { 
        deck = data; updateUI(); 
    }).catch(err => console.error(err));

    document.getElementById('lang-select').addEventListener('change', (e) => {
        currentLang = e.target.value;
        resetToggles();
        updateUI();
    });

    // --- LEVEL LOGIC ---
    function updateLevel(val) {
        currentLevel = parseInt(val);
        document.getElementById('lvl-txt').innerText = `Level ${currentLevel}`;
        
        // Update Slider Color
        const slider = document.getElementById('level-slider');
        slider.className = `lvl-${currentLevel}`;

        // Re-render toggles based on visibility
        updateControls('header-toggles');
        if(document.getElementById('child-mode').style.display === 'flex') updateControls('child-toggles');
    }

    function resetToggles() {
        Object.keys(toggleState).forEach(k => toggleState[k] = false);
    }

    function updateUI() {
        updateControls('header-toggles');
        renderGrid();
    }

    function getFontClass() {
        if (currentLang === 'ja') return 'font-ja';
        if (currentLang === 'ko') return 'font-ko';
        if (currentLang === 'zh') return toggleState.traditional ? 'font-zh-tw' : 'font-zh-cn';
        return 'font-en';
    }

    // --- CONTROLS ---
    function updateControls(containerId) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        const config = langConfig[currentLang];
        
        config.toggles.forEach(key => {
            const minLevel = levelConfig[key] || 1;
            // Only show if current Level >= minLevel
            if (currentLevel >= minLevel) {
                const inputID = `chk-${containerId}-${key}`;
                const html = `
                    <label class="toggle-group" id="lbl-${containerId}-${key}">
                        <span class="switch">
                            <input type="checkbox" id="${inputID}" data-key="${key}" onchange="toggleFeature('${key}', this.checked)" ${toggleState[key]?'checked':''}>
                            <span class="slider"></span>
                        </span>
                        ${toggleLabels[key]}
                    </label>`;
                container.insertAdjacentHTML('beforeend', html);
            }
        });
        checkDependency();
    }

    window.toggleFeature = function(key, isChecked) {
        toggleState[key] = isChecked;
        // Logic: Fem/Neut are mutually exclusive
        if(key === 'fem' && isChecked) toggleState.neut = false;
        if(key === 'neut' && isChecked) toggleState.fem = false;

        // Sync UI inputs
        document.querySelectorAll(`input[data-key]`).forEach(el => {
            const k = el.getAttribute('data-key');
            el.checked = toggleState[k];
        });

        if(key==='plural') checkDependency();
        renderGrid();
        if(document.getElementById('child-mode').style.display === 'flex') updateDisplay();
    };

    function checkDependency() {
        const isPlural = toggleState.plural;
        const artInputs = document.querySelectorAll(`input[data-key="article"]`);
        const artLabels = document.querySelectorAll(`label[id*="-article"]`);
        if (isPlural) {
            toggleState.article = false;
            artInputs.forEach(el => { el.checked = false; el.disabled = true; });
            artLabels.forEach(el => el.classList.add('disabled'));
        } else {
            artInputs.forEach(el => { el.disabled = false; });
            artLabels.forEach(el => el.classList.remove('disabled'));
        }
    }

    // --- COMPLEX TEXT LOGIC (L3) ---
    function getTextDisplay(card) {
        let raw = card.translations[currentLang] || card.translations['en']; 
        if (!raw || typeof raw === 'string') return { main: raw || '?', sub: '', gender: '' };

        let mainText = (currentLang === 'zh' && toggleState.traditional && raw.t) ? raw.t : (raw.n || '?');
        let genderText = (toggleState.gender && raw.g) ? raw.g : '';
        let subText = '';

        // LEVEL 2 LOGIC
        if (toggleState.plural && raw.p) mainText = raw.p;
        
        // LEVEL 3 LOGIC (Verbs)
        if (toggleState.conjugate && raw.pres) mainText = raw.pres;

        // LEVEL 3 LOGIC (Adjectives)
        // Order of precedence: Plural > Fem/Neut > Base
        if (card.pos === 'adj') {
            if (toggleState.plural) {
                // Check gendered plurals (mp/fp) or generic (p)
                if (toggleState.fem && raw.fp) mainText = raw.fp;
                else if (raw.mp) mainText = raw.mp; // Default plural masc for romance
                else if (raw.p) mainText = raw.p;
            } else if (toggleState.fem && raw.f) {
                mainText = raw.f;
            } else if (toggleState.neut && raw.nt) {
                mainText = raw.nt;
            }
        }

        // L1 Logic (Article) - Apply last so it wraps the modified word
        if (toggleState.article && !toggleState.plural && raw.art) mainText = `${raw.art} ${mainText}`;

        // SUBTEXT LOGIC
        if (toggleState.pinyin && raw.py) subText = raw.py;
        if (toggleState.latin && raw.lt) subText = raw.lt;
        if (toggleState.ipa && raw.ipa) subText = `[${raw.ipa}]`;
        if (currentLang === 'ja' && toggleState.hiragana && raw.r) subText = `(${raw.r})`;
        if (currentLang === 'ko' && toggleState.hanja && raw.hj) { subText = `(${mainText})`; mainText = raw.hj; }

        return { main: mainText, sub: subText, gender: genderText };
    }

    // --- RENDERERS ---
    function renderGrid() {
        const fontClass = getFontClass();
        document.getElementById('grid').innerHTML = deck.map(card => {
            const txt = getTextDisplay(card);
            const col = colors[card.cat] || '#ccc';
            const posClass = `pos-${card.pos || 'noun'}`;
            const posLabel = card.pos || '';
            const grammarVisibility = toggleState.grammar ? 'show-grammar' : '';

            return `
            <div class="vocab-card" onclick="startChildAt('${card.id}')">
                <div class="card-inner" id="card-${card.id}">
                    <div class="card-front">
                        <div class="flip-btn" onclick="flipCard(event, '${card.id}')">üîÑ</div>
                        <div class="card-art"><img src="${card.img}" onerror="this.src='https://via.placeholder.com/300'" loading="lazy"></div>
                        <div class="card-obi ${grammarVisibility}">
                            <div class="word-row">
                                <div class="word ${fontClass}">${txt.main}</div>
                            </div>
                            <div class="pos-badge ${posClass}">${posLabel}</div>
                            ${txt.sub ? `<div class="sub-word">${txt.sub}</div>` : ''}
                            ${txt.gender ? `<div class="gender-badge">${txt.gender}</div>` : ''}
                            <div class="color-stroke" style="background:${col}"></div>
                        </div>
                    </div>
                    <div class="card-back">
                        <div class="back-title">Gender Compare</div>
                        <table class="comp-table">
                            ${buildCompRow(card, 'fr', 'üá´üá∑')}${buildCompRow(card, 'de', 'üá©üá™')}
                            ${buildCompRow(card, 'it', 'üáÆüáπ')}${buildCompRow(card, 'ru', 'üá∑üá∫')}
                        </table>
                        <button class="close-flip" onclick="flipCard(event, '${card.id}')">Close</button>
                    </div>
                </div>
            </div>`;
        }).join('');
    }

    // --- CHILD MODE ---
    function startChildAt(id) { currentIndex = deck.findIndex(c => c.id === id); startChild(); }
    function startChild() { if(deck.length>0){ document.getElementById('child-mode').style.display = 'flex'; updateControls('child-toggles'); updateDisplay(); } }
    function exitChild() { document.getElementById('child-mode').style.display = 'none'; window.speechSynthesis.cancel(); }
    
    function updateDisplay() {
        const card = deck[currentIndex];
        const txt = getTextDisplay(card);
        const col = colors[card.cat] || '#333';
        const fontClass = getFontClass();
        
        const wordEl = document.getElementById('c-word');
        wordEl.className = ''; wordEl.classList.add(fontClass);

        document.getElementById('c-img').src = card.img;
        wordEl.innerText = txt.main;
        document.getElementById('c-sub').innerText = txt.sub;
        document.getElementById('c-gender').innerText = txt.gender;
        document.getElementById('c-stripe').style.background = col;
        
        const posEl = document.getElementById('c-pos');
        posEl.className = `pos-badge pos-${card.pos || 'noun'}`;
        posEl.innerText = card.pos || '';
        posEl.style.display = toggleState.grammar ? 'inline-block' : 'none';
    }

    // --- UTILS ---
    function move(dir) { window.speechSynthesis.cancel(); currentIndex = (currentIndex + dir + deck.length) % deck.length; updateDisplay(); }
    function getGenderClass(g) { if(!g)return''; if(g.includes('masc'))return'g-masc'; if(g.includes('fem'))return'g-fem'; if(g.includes('neut'))return'g-neut'; return ''; }
    function buildCompRow(c,l,f) { const d=c.translations[l]; if(!d)return''; const g=getGenderClass(d.g||''); return `<tr><td class="comp-flag">${f}</td><td class="comp-art ${g}">${d.art||''}</td><td class="comp-word ${g}">${d.n||''}</td></tr>`; }
    window.flipCard = function(e, id) { e.stopPropagation(); const p=document.getElementById(`card-${id}`).parentElement; if(p.classList.contains('flipped'))p.classList.remove('flipped'); else {document.querySelectorAll('.vocab-card').forEach(c=>c.classList.remove('flipped')); p.classList.add('flipped');} };

    function speakDrill() {
        const card = deck[currentIndex];
        // Note: Speech synthesis might not be perfect for Level 3 grammar forms depending on the browser voice
        const txt = getTextDisplay(card); // Use the processed text for speech
        let textToSpeak = txt.main; 

        const locales = { 'en':'en-GB', 'fr':'fr-FR', 'de':'de-DE', 'it':'it-IT', 'ru':'ru-RU', 'zh':'zh-CN', 'ja':'ja-JP', 'ko':'ko-KR' };
        const voice = window.speechSynthesis.getVoices().find(v => v.lang.includes(locales[currentLang]||'en-US')) || window.speechSynthesis.getVoices()[0];
        window.speechSynthesis.cancel();
        const u1=new SpeechSynthesisUtterance(textToSpeak); u1.voice=voice; u1.rate=1.0;
        const u2=new SpeechSynthesisUtterance(textToSpeak); u2.voice=voice; u2.rate=0.6;
        const u3=new SpeechSynthesisUtterance(textToSpeak); u3.voice=voice; u3.rate=1.0;
        u1.onend=()=>setTimeout(()=>window.speechSynthesis.speak(u2),600); u2.onend=()=>setTimeout(()=>window.speechSynthesis.speak(u3),600); window.speechSynthesis.speak(u1);
    }
    
    // Print functions same as before (omitted for brevity, assume included)
    function printPoker() {
        const f = getFontClass(); document.getElementById('print-area').className='grid-poker';
        document.getElementById('print-area').innerHTML=deck.map(c=>{const t=getTextDisplay(c); return `<div class="cut-guide"><img src="${c.img}"><div class="txt"><div class="${f}">${t.main}</div>${t.sub?`<div style="font-size:0.6em;color:#666;">${t.sub}</div>`:''}</div><div class="bar" style="background:${colors[c.cat]||'#ccc'}"></div></div>`;}).join(''); window.print();
    }
    function printA4() {
        const f = getFontClass(); document.getElementById('print-area').className='layout-a4';
        document.getElementById('print-area').innerHTML=deck.map(c=>{const t=getTextDisplay(c); return `<div class="page"><div class="cut-guide"><img src="${c.img}"><div class="bar" style="background:${colors[c.cat]||'#ccc'}"></div><div class="txt"><div class="${f}">${t.main}</div>${t.sub?`<div style="font-size:0.4em;color:#666;">${t.sub}</div>`:''}</div></div></div>`;}).join(''); window.print();
    }
</script>
</body>
</html>