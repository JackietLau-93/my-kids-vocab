<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>TinyVocab Ultimate</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Jua&family=Noto+Sans+TC:wght@700&family=ZCOOL+KuaiLe&family=Zen+Maru+Gothic:wght@500;700&display=swap" rel="stylesheet">

<style>
    :root {
        --c-animal: #7CB342; --c-food: #FDD835; --c-body: #42A5F5; 
        --c-home: #EF5350; --c-act: #AB47BC;
        --bg: #F2F2F2; --card-bg: #FFFFFF;
        
        /* Gender Colors */
        --g-masc: #2196F3; /* Blue */
        --g-fem: #E91E63;  /* Pink */
        --g-neut: #4CAF50; /* Green */
    }

    body { 
        font-family: 'Zen Maru Gothic', sans-serif; background: var(--bg); 
        margin: 0; color: #333; -webkit-font-smoothing: antialiased;
    }

    /* --- LANGUAGE SPECIFIC FONTS --- */
    .font-en, .font-fr, .font-de, .font-it, .font-ru { font-family: 'Fredoka One', cursive; }
    .font-ja { font-family: 'Zen Maru Gothic', sans-serif; font-weight: 700; }
    .font-ko { font-family: 'Jua', sans-serif; }
    .font-zh-cn { font-family: 'ZCOOL KuaiLe', cursive; letter-spacing: 1px; }
    .font-zh-tw { font-family: 'Noto Sans TC', sans-serif; font-weight: 700; }

    /* --- HEADER --- */
    header { 
        background: rgba(255,255,255,0.98); padding: 15px 20px; 
        position: sticky; top: 0; z-index: 100;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        display: flex; flex-direction: column; gap: 10px;
    }
    
    .top-row { display: flex; justify-content: space-between; align-items: center; width: 100%; flex-wrap: wrap; gap: 10px;}
    .controls-row { display: flex; gap: 12px; align-items: center; padding-top: 5px; border-top: 1px solid #f0f0f0; flex-wrap: wrap;}

    .btn { padding: 8px 16px; border: 1px solid #ddd; border-radius: 20px; cursor: pointer; background: white; font-family: 'Fredoka One'; color: #555; font-size: 0.85rem;}
    .btn-primary { background: #333; color: white; border-color: #333; }
    
    #lang-select {
        padding: 8px 12px; border: 1px solid #ddd; border-radius: 20px;
        font-family: 'Zen Maru Gothic'; font-weight: bold; color: #333; background: white; outline: none;
    }

    /* TOGGLE SWITCHES */
    .toggle-group { display: flex; align-items: center; gap: 6px; font-size: 0.85rem; font-weight: bold; color: #555; cursor: pointer; background: #fff; padding: 4px 8px; border-radius: 15px; border: 1px solid #eee; transition: opacity 0.3s; }
    .switch { position: relative; display: inline-block; width: 36px; height: 20px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: #333; }
    input:checked + .slider:before { transform: translateX(16px); }
    .toggle-group.disabled { opacity: 0.4; pointer-events: none; filter: grayscale(1); }

    /* --- 3D FLIP CARD CONTAINER --- */
    .container { max-width: 1200px; margin: 0 auto; padding: 30px 20px; }
    .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(170px, 1fr)); gap: 25px; }
    
    .vocab-card {
        aspect-ratio: 3/4; 
        background-color: transparent;
        perspective: 1000px; /* Essential for 3D effect */
        cursor: pointer;
    }

    .card-inner {
        position: relative;
        width: 100%; height: 100%;
        text-align: center;
        transition: transform 0.6s;
        transform-style: preserve-3d;
        border-radius: 16px; 
        box-shadow: 0 10px 25px rgba(0,0,0,0.06);
    }

    .vocab-card.flipped .card-inner {
        transform: rotateY(180deg);
    }

    .card-front, .card-back {
        position: absolute;
        width: 100%; height: 100%;
        -webkit-backface-visibility: hidden; /* Safari */
        backface-visibility: hidden;
        border-radius: 16px; 
        overflow: hidden;
        background: var(--card-bg);
        display: flex; flex-direction: column;
    }

    .card-back {
        transform: rotateY(180deg);
        background: #fdfdfd;
        padding: 15px; box-sizing: border-box;
        display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
    }

    /* --- FRONT CONTENT --- */
    .card-art { flex: 1; width: 100%; display: flex; align-items: center; justify-content: center; padding: 15px; box-sizing: border-box; }
    .card-art img { max-width: 100%; max-height: 100%; object-fit: contain; filter: brightness(1.03) contrast(1.03); mix-blend-mode: multiply; }

    .card-obi { min-height: 80px; display: flex; flex-direction: column; align-items: center; justify-content: center; padding-bottom: 5px; position: relative; }
    .color-stroke { position: absolute; bottom: 0; left: 0; width: 100%; height: 6px; }
    
    .word { font-size: 1.8rem; color: #333; text-align: center; line-height: 1.2; margin-bottom: 2px;}
    .sub-word { font-size: 0.9rem; color: #777; font-family: 'Zen Maru Gothic'; text-align: center; font-weight: 500;}
    .gender-badge { font-size: 0.75rem; color: #999; font-style: italic; margin-top: 2px; font-family: 'Zen Maru Gothic';}

    /* FLIP BUTTON */
    .flip-btn {
        position: absolute; top: 10px; right: 10px;
        width: 32px; height: 32px; border-radius: 50%;
        background: rgba(255,255,255,0.9); border: 1px solid #eee;
        display: flex; align-items: center; justify-content: center;
        font-size: 1.2rem; cursor: pointer; z-index: 10;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        transition: transform 0.2s;
    }
    .flip-btn:hover { transform: scale(1.1); background: white; }

    /* --- BACK CONTENT (COMPARISON TABLE) --- */
    .back-title { font-family: 'Fredoka One'; font-size: 1.1rem; color: #333; margin-bottom: 15px; margin-top: 10px; }
    .comp-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; text-align: left; }
    .comp-table tr { border-bottom: 1px solid #eee; }
    .comp-table td { padding: 8px 4px; }
    .comp-flag { font-size: 1.2rem; width: 30px; }
    .comp-art { font-weight: bold; width: 30px; }
    .comp-word { font-weight: 500; color: #555; }
    
    /* Gender Highlights */
    .g-masc { color: var(--g-masc); }
    .g-fem { color: var(--g-fem); }
    .g-neut { color: var(--g-neut); }
    
    .close-flip {
        margin-top: auto; padding: 8px 20px; border-radius: 20px;
        background: #eee; border: none; font-family: 'Fredoka One'; color: #555;
        cursor: pointer;
    }

    /* --- CHILD MODE --- */
    #child-mode { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #fff; z-index: 200; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    .focus-card { width: 85vw; max-width: 400px; aspect-ratio: 3/4; background: white; border-radius: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.1); display: flex; flex-direction: column; overflow: hidden; }
    .focus-card img { flex: 1; object-fit: contain; padding: 40px; filter: brightness(1.03) contrast(1.03); mix-blend-mode: multiply; }
    .focus-card .word-box { height: 140px; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 10px; box-sizing: border-box;}
    .focus-card h1 { font-size: 3.5rem; margin: 0; color: #333; line-height: 1; }
    .focus-card h2 { font-family: 'Zen Maru Gothic'; font-size: 1.5rem; margin: 8px 0 0 0; color: #888; font-weight: normal; }
    .focus-stripe { height: 10px; width: 100%; }
    
    .controls { margin-top: 30px; display: flex; gap: 20px; }
    .nav-btn { width: 70px; height: 70px; border-radius: 50%; border: none; font-size: 2rem; background: #f5f5f5; cursor: pointer; color: #333; }
    .play-btn { width: 90px; height: 90px; font-size: 3rem; background: #333; color: white; }

    /* --- PRINT STYLES --- */
    #print-area { display: none; }
    @media print {
        header, .container, #child-mode { display: none !important; }
        #print-area { display: block !important; width: 100%; height: 100%; }
        .cut-guide { border: 1px dashed #e0e0e0; box-sizing: border-box; background: white; position: relative; display: flex; flex-direction: column; border-radius: 6px; }
        .grid-poker { display: grid; grid-template-columns: repeat(3, 63.5mm); grid-template-rows: repeat(3, 88.9mm); padding: 10mm; gap: 2mm; }
        .grid-poker .cut-guide { width: 63.5mm; height: 88.9mm; }
        .grid-poker img { flex: 1; width: 100%; object-fit: contain; padding: 10px; }
        .grid-poker .txt { height: 25mm; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 18pt; color: #333; margin-bottom: 2mm; text-align: center;}
        .grid-poker .bar { height: 3mm; width: 100%; position: absolute; bottom: 0; left: 0; }
        
        .layout-a4 .page { break-after: page; width: 100vw; height: 100vh; display: flex; align-items: center; justify-content: center; }
        .layout-a4 .cut-guide { width: 260mm; height: 180mm; border: none; flex-direction: row; }
        .layout-a4 img { flex: 2; object-fit: contain; padding: 0; }
        .layout-a4 .txt { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 80pt; color: #333; text-align: center; }
        .layout-a4 .bar { width: 15px; height: 100%; position: static; }
    }
</style>
</head>
<body>

<header>
    <div class="top-row">
        <div style="font-weight:bold; font-size:1.2rem; color:#333; font-family:'Fredoka One'">ü¶Å TinyVocab</div>
        <select id="lang-select">
            <option value="en">üá¨üáß English</option>
            <option value="fr">üá´üá∑ French</option>
            <option value="de">üá©üá™ German</option>
            <option value="it">üáÆüáπ Italian</option>
            <option value="ru">üá∑üá∫ Russian</option>
            <option value="zh">üá®üá≥ Chinese</option>
            <option value="ja">üáØüáµ Japanese</option>
            <option value="ko">üá∞üá∑ Korean</option>
        </select>
        <div style="display:flex; gap:8px;">
            <button class="btn" onclick="printA4()">Poster</button>
            <button class="btn" onclick="printPoker()">Cards</button>
            <button class="btn btn-primary" onclick="startChild()">‚ñ∂ Child Mode</button>
        </div>
    </div>
    
    <div class="controls-row" id="toggle-container"></div>
</header>

<div class="container">
    <div class="card-grid" id="grid"></div>
</div>

<div id="child-mode" style="display:none;">
    <button onclick="exitChild()" style="position:absolute; top:30px; right:30px; border:none; background:none; font-size:2rem; opacity:0.3; cursor:pointer;">‚úï</button>
    <div class="focus-card" id="focus-display">
        <img id="c-img" src="">
        <div class="word-box">
            <h1 id="c-word">Word</h1>
            <h2 id="c-sub"></h2>
            <div id="c-gender" class="gender-badge" style="font-size: 1.2rem;"></div>
        </div>
        <div class="focus-stripe" id="c-stripe"></div>
    </div>
    <div class="controls">
        <button class="nav-btn" onclick="move(-1)">üëà</button>
        <button class="nav-btn play-btn" onclick="speakDrill()">üîä</button>
        <button class="nav-btn" onclick="move(1)">üëâ</button>
    </div>
</div>

<div id="print-area"></div>

<script>
    let deck = [];
    let currentIndex = 0;
    let currentLang = 'en';

    // --- CONFIGS ---
    const langConfig = {
        'en': { toggles: ['article', 'plural'] },
        'fr': { toggles: ['article', 'plural', 'gender'] },
        'de': { toggles: ['article', 'plural', 'gender'] },
        'it': { toggles: ['article', 'plural', 'gender'] },
        'ru': { toggles: ['plural', 'gender', 'latin'] },
        'zh': { toggles: ['traditional', 'pinyin'] },
        'ja': { toggles: ['hiragana'] },
        'ko': { toggles: ['hanja'] }
    };

    const toggleLabels = { 'plural':'Plural', 'article':'Article', 'gender':'Gender', 'pinyin':'Pinyin', 'latin':'Latin', 'hiragana':'Hiragana', 'hanja':'Hanja', 'traditional':'Traditional' };
    let toggleState = { plural:false, article:false, gender:false, pinyin:false, latin:false, hiragana:false, hanja:false, traditional:false };
    const colors = { animal: '#7CB342', food: '#FDD835', body: '#42A5F5', home: '#EF5350', act: '#AB47BC' };

    // --- INIT ---
    fetch('data.json').then(res => res.json()).then(data => { 
        deck = data; updateControls(); renderGrid(); 
    }).catch(err => console.error(err));

    document.getElementById('lang-select').addEventListener('change', (e) => {
        currentLang = e.target.value;
        Object.keys(toggleState).forEach(k => toggleState[k] = false);
        updateControls(); renderGrid();
    });

    // --- FONT HELPER ---
    function getFontClass() {
        if (currentLang === 'ja') return 'font-ja';
        if (currentLang === 'ko') return 'font-ko';
        if (currentLang === 'zh') return toggleState.traditional ? 'font-zh-tw' : 'font-zh-cn';
        return 'font-en'; // Default for En, Fr, De, It, Ru
    }

    // --- CONTROLS UI ---
    function updateControls() {
        const container = document.getElementById('toggle-container');
        container.innerHTML = '';
        const config = langConfig[currentLang];
        config.toggles.forEach(key => {
            const html = `
                <label class="toggle-group" id="lbl-${key}">
                    <span class="switch">
                        <input type="checkbox" id="chk-${key}" onchange="toggleFeature('${key}', this.checked)" ${toggleState[key] ? 'checked' : ''}>
                        <span class="slider"></span>
                    </span>
                    ${toggleLabels[key]}
                </label>`;
            container.insertAdjacentHTML('beforeend', html);
        });
        checkDependency();
    }

    window.toggleFeature = function(key, isChecked) {
        toggleState[key] = isChecked;
        if(key==='plural') checkDependency();
        renderGrid();
        if(document.getElementById('child-mode').style.display === 'flex') updateDisplay();
    };

    function checkDependency() {
        const pluralChk = document.getElementById('chk-plural');
        const artChk = document.getElementById('chk-article');
        if (pluralChk && artChk) {
            if (pluralChk.checked) {
                artChk.checked = false; artChk.disabled = true; toggleState.article = false;
                document.getElementById('lbl-article').classList.add('disabled');
            } else {
                artChk.disabled = false;
                document.getElementById('lbl-article').classList.remove('disabled');
            }
        }
    }

    // --- TEXT LOGIC ---
    function getTextDisplay(card) {
        let raw = card.translations[currentLang] || card.translations['en']; 
        if (!raw || typeof raw === 'string') return { main: raw || '?', sub: '', gender: '' };

        let mainText = (currentLang === 'zh' && toggleState.traditional && raw.t) ? raw.t : (raw.n || '?');
        
        if (toggleState.plural && raw.p) mainText = raw.p;
        if (toggleState.article && !toggleState.plural && raw.art) mainText = `${raw.art} ${mainText}`;

        let subText = '';
        if (toggleState.pinyin && raw.py) subText = raw.py;
        if (toggleState.latin && raw.lt) subText = raw.lt;
        if (currentLang === 'ja' && toggleState.hiragana && raw.r) subText = `(${raw.r})`;
        if (currentLang === 'ko' && toggleState.hanja && raw.hj) { subText = `(${mainText})`; mainText = raw.hj; }

        let genderText = (toggleState.gender && raw.g) ? raw.g : '';

        return { main: mainText, sub: subText, gender: genderText };
    }

    // --- COMPARISON LOGIC ---
    function getGenderClass(g) {
        if(!g) return '';
        if(g.includes('masc')) return 'g-masc';
        if(g.includes('fem')) return 'g-fem';
        if(g.includes('neut')) return 'g-neut';
        return '';
    }

    function buildCompRow(card, langCode, flag) {
        const data = card.translations[langCode];
        if(!data) return '';
        const art = data.art || '';
        const word = data.n || '';
        const gen = data.g || '';
        const gClass = getGenderClass(gen);
        
        return `
            <tr>
                <td class="comp-flag">${flag}</td>
                <td class="comp-art ${gClass}">${art}</td>
                <td class="comp-word ${gClass}">${word}</td>
            </tr>
        `;
    }

    // --- RENDER GRID ---
    function renderGrid() {
        const fontClass = getFontClass();
        
        document.getElementById('grid').innerHTML = deck.map(card => {
            const txt = getTextDisplay(card);
            const col = colors[card.cat] || '#ccc';
            
            const comparisonHTML = `
                <table class="comp-table">
                    ${buildCompRow(card, 'fr', 'üá´üá∑')}
                    ${buildCompRow(card, 'de', 'üá©üá™')}
                    ${buildCompRow(card, 'it', 'üáÆüáπ')}
                    ${buildCompRow(card, 'ru', 'üá∑üá∫')}
                </table>
            `;

            return `
            <div class="vocab-card" onclick="startChildAt('${card.id}')">
                <div class="card-inner" id="card-${card.id}">
                    <div class="card-front">
                        <div class="flip-btn" onclick="flipCard(event, '${card.id}')">üîÑ</div>
                        <div class="card-art"><img src="${card.img}" onerror="this.src='https://via.placeholder.com/300'" loading="lazy"></div>
                        <div class="card-obi">
                            <div class="word ${fontClass}">${txt.main}</div>
                            ${txt.sub ? `<div class="sub-word">${txt.sub}</div>` : ''}
                            ${txt.gender ? `<div class="gender-badge">${txt.gender}</div>` : ''}
                            <div class="color-stroke" style="background:${col}"></div>
                        </div>
                    </div>
                    <div class="card-back">
                        <div class="back-title">Gender Compare</div>
                        ${comparisonHTML}
                        <button class="close-flip" onclick="flipCard(event, '${card.id}')">Close</button>
                    </div>
                </div>
            </div>`;
        }).join('');
    }

    // Flip Logic
    window.flipCard = function(e, id) {
        e.stopPropagation(); 
        const cardInner = document.getElementById(`card-${id}`);
        const parent = cardInner.parentElement;
        if (parent.classList.contains('flipped')) {
            parent.classList.remove('flipped');
        } else {
            document.querySelectorAll('.vocab-card').forEach(c => c.classList.remove('flipped'));
            parent.classList.add('flipped');
        }
    };

    // --- CHILD MODE ---
    function startChildAt(id) { currentIndex = deck.findIndex(c => c.id === id); startChild(); }
    function startChild() { if(deck.length>0){ document.getElementById('child-mode').style.display = 'flex'; updateDisplay(); } }
    function exitChild() { document.getElementById('child-mode').style.display = 'none'; window.speechSynthesis.cancel(); }
    
    function updateDisplay() {
        const card = deck[currentIndex];
        const txt = getTextDisplay(card);
        const col = colors[card.cat] || '#333';
        
        // Font Logic
        const fontClass = getFontClass();
        const wordEl = document.getElementById('c-word');
        wordEl.className = ''; wordEl.classList.add(fontClass);

        document.getElementById('c-img').src = card.img;
        wordEl.innerText = txt.main;
        document.getElementById('c-sub').innerText = txt.sub;
        document.getElementById('c-gender').innerText = txt.gender;
        document.getElementById('c-stripe').style.background = col;
    }
    function move(dir) { window.speechSynthesis.cancel(); currentIndex = (currentIndex + dir + deck.length) % deck.length; updateDisplay(); }

    function speakDrill() {
        const card = deck[currentIndex];
        const raw = card.translations[currentLang] || card.translations['en'];
        let textToSpeak = raw.n; 
        if(toggleState.plural && raw.p) textToSpeak = raw.p;
        if(toggleState.article && !toggleState.plural && raw.art) textToSpeak = `${raw.art} ${textToSpeak}`;

        const locales = { 'en':'en-GB', 'fr':'fr-FR', 'de':'de-DE', 'it':'it-IT', 'ru':'ru-RU', 'zh':'zh-CN', 'ja':'ja-JP', 'ko':'ko-KR' };
        const target = locales[currentLang] || 'en-US';
        const voice = window.speechSynthesis.getVoices().find(v => v.lang.includes(target)) || window.speechSynthesis.getVoices()[0];
        
        window.speechSynthesis.cancel();
        
        // Drill: Normal -> Slow -> Normal
        const u1 = new SpeechSynthesisUtterance(textToSpeak); u1.voice = voice; u1.rate = 1.0;
        const u2 = new SpeechSynthesisUtterance(textToSpeak); u2.voice = voice; u2.rate = 0.6;
        const u3 = new SpeechSynthesisUtterance(textToSpeak); u3.voice = voice; u3.rate = 1.0;
        
        u1.onend = () => setTimeout(() => window.speechSynthesis.speak(u2), 600);
        u2.onend = () => setTimeout(() => window.speechSynthesis.speak(u3), 600);
        window.speechSynthesis.speak(u1);
    }

    // --- PRINTING ---
    function printPoker() {
        const fontClass = getFontClass();
        document.getElementById('print-area').className = 'grid-poker';
        document.getElementById('print-area').innerHTML = deck.map(c => {
            const txt = getTextDisplay(c);
            return `<div class="cut-guide"><img src="${c.img}">
                <div class="txt">
                    <div class="${fontClass}">${txt.main}</div>
                    ${txt.sub ? `<div style="font-size:0.6em; color:#666;">${txt.sub}</div>` : ''}
                </div>
                <div class="bar" style="background:${colors[c.cat]||'#ccc'}"></div>
            </div>`;
        }).join('');
        window.print();
    }
    function printA4() {
        const fontClass = getFontClass();
        document.getElementById('print-area').className = 'layout-a4';
        document.getElementById('print-area').innerHTML = deck.map(c => {
            const txt = getTextDisplay(c);
            return `<div class="page"><div class="cut-guide"><img src="${c.img}"><div class="bar" style="background:${colors[c.cat]||'#ccc'}"></div>
                <div class="txt">
                    <div class="${fontClass}">${txt.main}</div>
                    ${txt.sub ? `<div style="font-size:0.4em; color:#666;">${txt.sub}</div>` : ''}
                </div>
            </div></div>`;
        }).join('');
        window.print();
    }
</script>
</body>
</html>